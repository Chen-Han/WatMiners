/**
 * Created by Han Chen on 24/02/2015.
 */
app.service("$service",["$http","$firebaseAuth","$firebase","$timeout",function(n,e,a){var i=this
this.firebaseURL="https://watminers.firebaseio.com",this.authObj=null,this.refRanking=null,this.rankings=null,this.refJob=null,this.syncRanking=null,this.authData=null,this.login=function(n,a){i.refRanking=new Firebase(i.firebaseURL),i.authObj=e(i.refRanking),i.authObj.$authWithOAuthPopup("facebook").then(function(e){i.authData=e,console.log("Logged in as:",e),Firebase.goOffline(),n&&n()})["catch"](function(n){console.error("Authentication failed:",n),a&&a("login failed, try referesh the page")})},this.didUserRank=function(n,e){Firebase.goOnline()
var o=new Firebase(i.firebaseURL+"/rankings/"+i.authData.uid),t=a(o).$asArray()
t.$loaded().then(function(){Firebase.goOffline(),console.log(t),t.length>0?(i.rankings=t[0],n&&n()):e&&e()})["catch"](function(){Firebase.goOffline(),e&&e()})},this.addRankings=function(n,e,o){function t(){var t=new Firebase(i.firebaseURL+"/rankings/"+i.authData.uid),s=a(t).$asArray()
s.$add(n).then(function(){Firebase.goOffline(),e&&e()},function(n){console.log(n),Firebase.goOffline(),o&&o()})}Firebase.goOnline(),console.log(n)
for(var s=null,r=0;r<n.length;r++){console.log(n[r]),n[r].displayName=i.authData.facebook.displayName,n[r].jobID+=""
var l=a(new Firebase(i.firebaseURL+"/jobs/"+n[r].jobID))
s=l.$set(i.authData.uid,n[r])["catch"](function(n){o&&o(),console.log(n)})}s.then(t)},this.getRankings=function(n,e){function o(){Firebase.goOnline(),console.log(i.rankings)
for(var e=0;e<i.rankings.length;e++)!function(){var o=a(new Firebase(i.firebaseURL+"/jobs/"+i.rankings[e].jobID)).$asArray()
o.$loaded().then(function(){n&&n(o)})["catch"](function(n){console.log(n)})}()}i.rankings?o():i.didUserRank(o,e)}}])
